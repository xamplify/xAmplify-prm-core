#Total Recipients
campaign.totalRecipientsQueryString = select count (distinct xcuu.user_id )as  "Total Recipients" from xt_campaign xc left join xt_campaign_user_userlist xcuu on (xcuu.campaign_id = xc.campaign_id) \
where xc.campaign_id= :campaignId and is_launched = true

#Total Emails Sent
campaign.totalEmailsSentQueryString = select  count(distinct ceh.user_id) as  "Total Emails Sent" from  xt_campaign xc  left join xt_campaign_user_userlist xcuu on (xcuu.campaign_id = xc.campaign_id)  left join xt_campaign_emails_history ceh on (xc.campaign_id = ceh.campaign_id and xcuu.user_id = ceh.user_id) where xc.campaign_id=:campaignId

#Opened / Active RecipientsQueryString
campaign.activeRecipientsQueryString = select (cast (sum( a."Email Opened") as text)||' ('|| round((sum( a."Email Opened")/(CASE sum( a."Total Recipients") WHEN 0 THEN 1 ELSE sum( a."Total Recipients") end))*100,2) || '%)')  as "Active Recipients" from (select count( distinct case when xel.action_id = 13 and xel.url_id IS NULL  and xel.reply_id IS null then xel.user_id end) as  "Email Opened", count (distinct xcuu.user_id )as  "Total Recipients" from xt_campaign xc  left join xt_campaign_user_userlist xcuu on (xcuu.campaign_id = xc.campaign_id)  \
left join xt_email_log xel on (xel.campaign_id = xc.campaign_id and  xel.user_id = xcuu.user_id) where xc.campaign_id= :campaignId)a

#Opened
campaign.unsubscribedCountQueryString = select  count(distinct xuu.id) as  "Unsubscribed" from  xt_campaign xc  left join xt_campaign_user_userlist xcuu on (xcuu.campaign_id = xc.campaign_id)  \
left join xt_user_profile xup on (xc.customer_id = xup.user_id) left join xt_company_profile xcp on (xup.company_id = xcp.company_id) left join xt_unsubscribed_user xuu on xuu.customer_company_id  =  xcp.company_id and xcuu.user_id  =  xuu.user_id \
where xc.campaign_id=:campaignId

#Deliverability & Open Rate
campaign.deliverabilityAndOpenRatePercentageQueryString = select cast (round(sum( "Email Opened") / (case count ( distinct case when ( a."Bounce"=false and  a."Block"= false and  a."Spam"=false) \
and  a."Is_Email_Valid"=true then  a."Sent User" end) when 0 then 1 else   count (distinct case when ( a."Bounce"=false and  a."Block"= false and  a."Spam"=false) \
 and  a."Is_Email_Valid"=true then  a."Sent User" end) end ) *100, 2) as text) || '%' as "openRate", cast (count (distinct case when ( a."Bounce"=false and  a."Block"=false and  a."Spam"=false) and  a."Is_Email_Valid"=true then  a."Sent User" end) as text) \
 ||' ('||   round((count (distinct case when (a."Bounce"=false and a."Block"=false and  a."Spam"=false) and  a."Is_Email_Valid"=true then a. "Sent User" end) /  (CASE  sum(a."Total Emails Sent" ) WHEN 0 THEN 1 ELSE sum(a. "Total Emails Sent")  end)) *100, 2)  \
|| '%)' as "delivered" from (select xup2.is_email_valid as  "Is_Email_Valid", ceh.user_id as  "Sent User",  (case when sg.user_id=xcuu.user_id and (((DATE_PART('year',age(sg.created,xc.launch_time))*12*30*24+   DATE_PART('month',age(sg.created,xc.launch_time))*30*24+  \
DATE_PART('day',age(sg.created,xc.launch_time))*24+ DATE_PART('hour', age(sg.created,xc.launch_time) ))>=0) and  ((DATE_PART('year',age(sg.created,xc.launch_time))*12*30*24+ DATE_PART('month',age(sg.created,xc.launch_time))*30*24+  DATE_PART('day',age(sg.created,xc.launch_time))*24+ DATE_PART('hour', age(sg.created,xc.launch_time) ))<=3)) then true else false end) as  "Bounce",  (case when sg1.user_id=xcuu.user_id and  (((DATE_PART('year',age(sg1.created,xc.launch_time))*12*30*24+    DATE_PART('month',age(sg1.created,xc.launch_time))*30*24+  DATE_PART('day',age(sg1.created,xc.launch_time))*24+ DATE_PART('hour', age(sg1.created,xc.launch_time) ))>=0) and ((DATE_PART('year',age(sg1.created,xc.launch_time))*12*30*24+   DATE_PART('month',age(sg1.created,xc.launch_time))*30*24+  DATE_PART('day',age(sg1.created,xc.launch_time))*24+ DATE_PART('hour', age(sg1.created,xc.launch_time) ))<=3))  then true else false end) as  "Block",  (case when sg2.user_id=xcuu.user_id and  (((DATE_PART('year',age(sg2.created,xc.launch_time))*12*30*24+ DATE_PART('month',age(sg2.created,xc.launch_time))*30*24+ DATE_PART('day',age(sg2.created,xc.launch_time))*24+ DATE_PART('hour', age(sg2.created,xc.launch_time) ))>=0) and  ((DATE_PART('year',age(sg2.created,xc.launch_time))*12*30*24+   DATE_PART('month',age(sg2.created,xc.launch_time))*30*24+  DATE_PART('day',age(sg2.created,xc.launch_time))*24+ DATE_PART('hour', age(sg2.created,xc.launch_time) ))<=3)) then true else false end) as  "Spam", count( distinct case when xel.action_id = 13 and xel.url_id IS NULL  and xel.reply_id IS null then xel.user_id end) as  "Email Opened",count(distinct ceh.user_id) as  "Total Emails Sent"   from xt_campaign xc  left join xt_campaign_user_userlist xcuu on (xcuu.campaign_id = xc.campaign_id)  \
left join xt_user_profile xup2 on xup2.user_id = xcuu.user_id left join xt_email_log xel on (xel.campaign_id = xc.campaign_id and  xel.user_id = xcuu.user_id)  left join xt_campaign_emails_history ceh on (xc.campaign_id = ceh.campaign_id and xcuu.user_id = ceh.user_id)  left join xt_bounce sg on (xcuu.user_id = sg.user_id) left join xt_block sg1 on (xcuu.user_id = sg1.user_id) \
left join xt_spam sg2 on (xcuu.user_id = sg2.user_id) where xc.campaign_id= :campaignId group by 1,2,3,4,5)a


#Email Clicked
campaign.clickedUrlCountQueryString = select  cast(count ( distinct case when (xel.action_id = 14 OR xel.action_id = 15) AND xel.url_id IS NULL  and xel.reply_id IS NULL THEN xel.user_id else null end) as int) AS  "Email Clicked " \
from xt_campaign xc  left join xt_campaign_user_userlist xcuu on (xcuu.campaign_id = xc.campaign_id) left join xt_email_log xel on (xel.campaign_id = xc.campaign_id and  xel.user_id = xcuu.user_id) where xc.campaign_id=:campaignId



#Click Through Rate
campaign.clickthroughRatePercentageQueryString = select cast (round(sum( "Email Clicked ") / (CASE sum( "Email Opened") WHEN 0 THEN 1 ELSE  sum("Email Opened") end) *100, 2) as text) || '%' from (select count ( distinct case when (xel.action_id = 14 OR xel.action_id = 15) AND xel.url_id IS NULL   \
and xel.reply_id IS NULL THEN xel.user_id else null end) AS  "Email Clicked ", count( distinct case when xel.action_id = 13 and xel.url_id IS NULL  and xel.reply_id IS null then xel.user_id end) as  "Email Opened" from xt_campaign xc left join xt_campaign_user_userlist xcuu on (xcuu.campaign_id = xc.campaign_id)  \
left join xt_email_log xel on (xel.campaign_id = xc.campaign_id and  xel.user_id = xcuu.user_id)  where xc.campaign_id= :campaignId)a

#Video Views
campaign.viewsCountQueryString = select count(DISTINCT xxl.session_id) + count(distinct CASE WHEN xxl.action_id = 10 THEN xxl.id END) AS  "views" from xt_campaign xc \
left join xt_campaign_user_userlist xcuu on (xcuu.campaign_id = xc.campaign_id) \
left join xt_xtremand_log xxl ON (xxl.user_id = xcuu.user_id AND xc.campaign_id = xxl.campaign_id) where xc.campaign_id=:campaignId

#Hard Bounce
campaign.hardBounceCountQueryString = select count(distinct case when xup2.is_email_valid=true and sg.user_id="xcuu".user_id and  sg.created>=xc.launch_time and  \
(((DATE_PART('year',age(sg.created,xc.launch_time))*12*30*24+   DATE_PART('month',age(sg.created,xc.launch_time))*30*24+  DATE_PART('day',age(sg.created,xc.launch_time))*24+ DATE_PART('hour', age(sg.created,xc.launch_time) ))>=0) and  \
((DATE_PART('year',age(sg.created,xc.launch_time))*12*30*24+   DATE_PART('month',age(sg.created,xc.launch_time))*30*24+  DATE_PART('day',age(sg.created,xc.launch_time))*24+ DATE_PART('hour', age(sg.created,xc.launch_time) ))<=3))  \
then xcuu.user_id else null end) as  "Hard Bounce " from xt_campaign xc left join xt_campaign_user_userlist xcuu on (xcuu.campaign_id = xc.campaign_id)  left join xt_user_profile xup2 on xup2.user_id = xcuu.user_id left join xt_bounce sg on (xcuu.user_id = sg.user_id) \
where xc.campaign_id= :campaignId

#Soft Bounce
campaign.softBounceQueryString = select count(distinct case when xc.is_launched and xup2.is_email_valid=false then xcuu.user_id else null end) as  "Soft Bounce" from xt_campaign xc \
left join xt_campaign_user_userlist xcuu on (xcuu.campaign_id = xc.campaign_id)  left join xt_user_profile xup2 on xup2.user_id = xcuu.user_id where xc.campaign_id= :campaignId

#Lead Count
campaign.leadsCountQueryString = select count(distinct l.id) as leadCount from xt_lead l join xt_campaign rc on l.campaign_id = rc.campaign_id join xt_campaign c on (rc.parent_campaign_id is not null and c.campaign_id = rc.parent_campaign_id) or (rc.parent_campaign_id is null and c.campaign_id = rc.campaign_id) where (c.campaign_id= :campaignId or rc.campaign_id= :campaignId)

#Deal Count
campaign.dealsCountQueryString = select  count(distinct d.id) as dealCount from xt_deal d join xt_campaign rc on d.campaign_id = rc.campaign_id join xt_campaign c on (rc.parent_campaign_id is not null and c.campaign_id = rc.parent_campaign_id) or (rc.parent_campaign_id is null and c.campaign_id = rc.campaign_id) where (c.campaign_id= :campaignId or rc.campaign_id= :campaignId)

#Redistributed Count
campaign.redistributedCountQueryString =  select cast(count(*) as int)  from xt_campaign c where  c.is_launched and c.vendor_organization_id = :vendorCompanyId and c.is_nurture_campaign and c.parent_campaign_id  = :parentCampaignId

#Redistributed Count for Analytics
campaign.redistributedCountForAnalyticsQueryString = select count(distinct c.campaign_id) as leadCount \
from xt_campaign p left join xt_campaign c on p.campaign_id = c.parent_campaign_id where p.campaign_id = :campaignId  \
and c.is_launched = true
